@using Azmoon.Application.Service.WorkPlace.Dto
@using EndPoint.Site.Models
@using System.Web
@{
    ViewData["Title"] = " دسترسی مدیریتی";
    Layout = "~/Areas/Person/Views/Shared/_LayoutPerson.cshtml";
}
 @model GrantAccessViewModel

@{
    ViewData["Title"] = "اعطای دسترسی";
}


@using System.Globalization
@using System.Text
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

<div class="mb-4">
    <div class="card-header bg-info text-white">
        <i class="fas fa-user-shield"></i> دسترسی فعلی: @Model.UserName
    </div>

    @if (!Model.ExistingAccesses.Any())
        {
        <p class="text-muted">هیچ دسترسی ثبت‌شده‌ای وجود ندارد.</p>
        }
    else
        {
        <table class="table table-bordered table-sm">
            <thead class="thead-light">
                <tr>
                    <th>محل خدمت</th>
                    <th>سطح تأییدکننده</th>
                    <th>حذف</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.ExistingAccesses)
                    {
                    <tr>
                        <td>@item.WorkPlaceName</td>
                        <td>
                           

                            @switch (item.Level)
                                {
                                case 0:
                                    <span>کشوری</span>
                                    break;
                                case 1:
                                    <span>استانی</span>
                                    break;
                                case 2:
                                    <span>شهرستان</span>
                                    break;
                                default:
                                    <span class="text-muted">نامشخص</span>
                                    break;
                                }
                            
                        </td>
                        <td>
                            <form asp-action="DeleteAccess"
                                  asp-route-accessId="@item.AccessId"
                                  asp-route-userId="@Model.UserId"
                                  method="post"
                                  class="d-inline">
                                @Html.AntiForgeryToken()
                                <button type="submit"
                                        class="btn btn-outline-danger btn-sm"
                                        onclick="return confirm('آیا مطمئن هستید حذف شود؟');"
                                        title="حذف دسترسی">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    }
            </tbody>
        </table>
        }
</div>

<hr />

<div class="card mt-4">
  <div class="card-header bg-info text-white">
    <i class="fas fa-user-shield"></i> اعطای دسترسی به کاربر
  </div>
  <div class="card-body">

        @if (!ViewData.ModelState.IsValid)
            {
            <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle"></i> لطفاً موارد زیر را بررسی و اصلاح نمایید:
                <ul class="mt-2">
                    @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                        {
                        <li><i class="fas fa-times-circle text-danger"></i> @error.ErrorMessage</li>
                        }
                </ul>
            </div>
            }
    <form asp-action="GrantAccess" method="post">
      <input type="hidden" asp-for="UserId" />

      <div class="form-group">
        <label><i class="fas fa-map-marker-alt"></i> محل خدمت</label>
        <input type="hidden" asp-for="SelectedWorkPlaceId" id="SelectedWorkPlaceId" />
        <button type="button" class="btn btn-secondary btn-sm" data-toggle="modal" data-target="#placeModal">
          انتخاب محل خدمت
        </button>
        <div id="selectedPlaceText" class="mt-2 text-success font-weight-bold"></div>
                <input type="text"  id="WorkPlaceIdFake" class="form-control" name="WorkPlaceIdFake"  readonly/>
      </div>

      <div class="form-group mt-3">
        <label><i class="fas fa-layer-group"></i> سطح تایید مرخصی</label>
        <select asp-for="SelectedAccessLevel" class="form-control">
          <option value="">-- انتخاب سطح --</option>
          <option value="0">کشوری</option>
          <option value="1">استانی</option>
          <option value="2">شهرستانی</option>
        </select>
        <span asp-validation-for="AccessLevels" class="text-danger"></span>
      </div>

      <button type="submit" class="btn btn-success mt-3">
        <i class="fas fa-check"></i> ثبت دسترسی
      </button>
    </form>
  </div>
</div>


@functions
{
    void RenderCategoryRow(long? parentId)
        {
        bool FirstParent = (parentId == null) ? true : false;
        foreach (var item in Model.WorkPlaces.Where(p => p.ParentId == parentId).OrderBy(p => p.SortIndex).ToList())
            {

            var tb = Model.WorkPlaces.Where(p => p.ParentId == item.Id).ToList().Count();
            if (!item.IsChailren && tb == 0)
                {
                <li>
                    <i class="fas fa-sticky-note"></i>
                    @item.Name
                        <input type="checkbox" id="Id_@item.Id" name="ids[]" value="@item.Id" data-name="@item.Name" class="checkthis">
                </li>
                }
            else
                {
                <li>
                    <i class="far fa-folder" aria-hidden="true"></i>
                    @item.Name
                        <input type="checkbox" id="Id_@item.Id" name="ids[]" value="@item.Id" data-name="@item.Name" class="checkthis">
                    <span class="badge badge-primary">@tb</span>
                    <ul class="child2" style="list-style-type:none;" required>

                        @{
                            RenderCategoryRow(item.Id);
                        }
                    </ul>
                </li>
                }
            }
        }
}





<!-- 2) خود مدال Bootstrap 4.3 -->
<div class="modal fade" id="placeModal" tabindex="-1" role="dialog" aria-labelledby="placeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
        <div class="modal-content">

            <!-- Header مدال -->
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="placeModalLabel" style="color:#fff!important;">
                    <i class="fas fa-building"></i> انتخاب محل خدمت
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="بستن">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <!-- Body مدال -->
            <div class="modal-body">
                <div id="divCategotyTreeView">
                    <ul style="list-style-type:none;" id="RootTreeView" required>
                        <li>
                            @{
                                RenderCategoryRow(null);
                            }
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Footer مدال -->
            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary"
                        data-dismiss="modal">
                    انصراف
                </button>
                <button type="button" class="btn btn-primary mr-2" data-btn="save">ثبت انتخاب  </button>
            </div>
        </div>
    </div>
</div>
@section Scripts {

    <script>
        $(document).ready(function () {
            $("#divCategotyTreeView input[type=checkbox]").change(function () {


                if ($('#divCategotyTreeView input:checkbox:checked').length > 1) {
                    var tthis = $(this);
                    $(this).prop('checked', false);
                    Swal.fire({
                        icon: 'info',
                        title: `<span">گزینه دیگری در حال انتخاب است و شما فقط می توانید یک مورد را انتخاب نمائید</span>`,
                        showConfirmButton: false,
                        timer: 3000
                    })
                }

            });
            // hide childe treeView
            $(function () {
                $('#RootTreeView ul.child2').hide(300);

                $('#RootTreeView li').on('click', function (e) {

                    e.stopPropagation();
                    $(this).children('ul').toggle(500);
                    $(this).children('li').addClass('mr-4');
                    $(this).children('ul').addClass('mr-4');
                    // $(this).find('>:first-child').toggleClass('fa-plus-circle fa-minus-circle')
                    $(this).find('>:first-child').toggleClass('fa-folder  fa-folder-open')

                });
            });

               $('[data-btn="save"]').click(function (e) {
                e.preventDefault();
                $('input[type=checkbox]').each(function () {
                    if (this.checked) {
                        
                        $('#SelectedWorkPlaceId').val($(this).val());
                        $('#WorkPlaceIdFake').attr('placeholder', $(this).data('name'));
                        $('#WorkPlaceIdFake').val($(this).data('name'));
                        $('#placeModal').modal('hide');
                    }
                });

            });
        });
    </script>
 }
