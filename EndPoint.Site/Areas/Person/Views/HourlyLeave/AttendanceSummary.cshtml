
@{
    ViewData["Title"] = "ورود یا خروج کارکنان";
    Layout = "~/Areas/Person/Views/Shared/_LayoutPerson.cshtml";
    var workPlaceViewModels = ViewData["WorkPlaces"] as List<GetWorkPlaceViewModel>;
}

@model IPagedList<UserShowPersonDto>
@using Azmoon.Application.Service.WorkPlace.Dto
@using EndPoint.Site.Models
@using X.PagedList
@using X.PagedList.Mvc.Core

@using X.PagedList.Mvc.Core.Common
@using X.PagedList.Web.Common

<div class="container mt-4">
    <h4 class="mb-3 text-center"> گزارش تردد روزانه و ماهیانه  کارکنان‌</h4>
    <div class="row">
        <div class="col-sm-12 col-12">
            <form asp-action="AttendanceSummary" method="get">

                <div class="row">

                    <div class="row col-9">
                        <div class="input-group col">
                            <input type="text" name="q" class="form-control float-right" placeholder="جستجونام خانوادگی یا پرسنلی">
                            <input type="text" name="mcode" class="form-control float-right" placeholder="جستجو  کد ملی">
                            <div class="input-group-append">
                                <span class="input-group-text"><i class="fa fa-search"></i></span>
                            </div>
                            <button type="submit" class="btn btn-primary" style="height: 38px;">جستجو</button>
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm col-auto" style="height: 38px;" data-toggle="modal" data-target="#placeModal">
                           بر اساس محل خدمت
                        </button>
                    </div>
                    <div class="col-sm-3 col-xs-3">
                        <div class="form-group form-group-sm">


                            <form class="form-inline d-inline" asp-action="AttendanceSummary" method="get">
                                <button type="submit" name="search" value="clear" class="btn btn-default d-inline">
                                    پاک کن
                                </button>
                            </form>

                        </div>
                    </div>
                </div>

            </form>
        </div>


    </div>
    <table class="table table-bordered text-center">
        <thead class="thead-light">
            <tr>
                <th>نام و نام خانوادگی</th>
                <th>محل خدمت  </th>
                <th>شماره پرسنلی </th>
                <th>ترددهای  روزانه</th>
                <th>  گزارش ماهانه</th> 
                <th>دسترسی  </th>
            </tr>
        </thead>
        <tbody>
            @{
                if (Model!=null)
                    {
                    foreach (var emp in Model)
                        {
                        <tr>
                            <td>@emp.FirstName &nbsp; @emp.LastName</td>
                            <td>@emp.WorkPlaceName</td>
                            <td>@emp.UserName</td>
                            <td>
                                <a asp-action="AttendanceDetailsByDate" asp-route-id="@emp.Id" class="btn btn-sm btn-primary">
                                    مشاهده 
                                </a>
                            </td>
                            <td>
                                <a class="btn btn-outline-primary btn-sm"
                                asp-area="Person"
                                asp-controller="Report"
                                asp-action="MonthlyReportForm"
                                asp-route-employeeId="@emp.Id"
                                data-toggle="tooltip"
                                title="مشاهده گزارش ماهانه">
                                    <i class="fas fa-calendar-alt"></i>  
                                </a>
                            </td>
                            <td>
                                <a asp-area="Person"
                                asp-controller="HourlyLeave"
                                asp-action="GrantAccess"
                                asp-route-userId="@emp.Id"
                                class="btn btn-outline-info btn-sm"
                                title="دسترسی">
                                    <i class="fas fa-user-shield"></i>
                                </a>
                            </td>
                        </tr>
                        }
                    }
                else
                    {

                    <div class="alert alert-primary h4">
                        <strong>متاسفم! </strong> هیچ رکوردی یافت نگردید .
                    </div>
                    }
            }
        </tbody>
    </table>
    @if (Model != null)
        {
            <!-- صفحه‌بندی -->
    <div class="text-center mt-3">
        @Html.PagedListPager(Model, page => Url.Action("AttendanceSummary", new { page }),
                 new PagedListRenderOptions
            {
            DisplayLinkToFirstPage = PagedListDisplayMode.Always,
            DisplayLinkToLastPage = PagedListDisplayMode.Always,
            DisplayLinkToPreviousPage = PagedListDisplayMode.Always,
            DisplayLinkToNextPage = PagedListDisplayMode.Always,
            DisplayLinkToIndividualPages = true, // این مورد مجاز است چون نوعش bool است
            MaximumPageNumbersToDisplay = 5,
            UlElementClasses = new[] { "pagination" },
            LiElementClasses = new[] { "page-item" },
            PageClasses = new[] { "page-link" }
            })
    </div>

        }

</div>
@functions
{
    
    void RenderCategoryRow(long? parentId, List<GetWorkPlaceViewModel> places)
        {
        bool FirstParent = (parentId == null) ? true : false;
        foreach (var item in places.Where(p => p.ParentId == parentId).OrderBy(p => p.SortIndex).ToList())
            {

            var tb = places.Where(p => p.ParentId == item.Id).ToList().Count();
            if (!item.IsChailren && tb == 0)
                {
                <li>

                    <i class="fas fa-sticky-note"></i>

                    @item.Name

                    @if (!FirstParent)
                        {
                        <input type="checkbox" id="Id_@item.Id" name="ids[]" value="@item.Id" data-name="@item.Name" class="checkthis">
                        }





                </li>
                }
            else
                {
                <li>

                    <i class="far fa-folder" aria-hidden="true"></i>

                    @item.Name

                    @if (!FirstParent)
                        {
                        <input type="checkbox" id="Id_@item.Id" name="ids[]" value="@item.Id" data-name="@item.Name" class="checkthis">
                        }




                    <span class="badge badge-primary">@tb</span>
                    <ul class="child2" style="list-style-type:none;" required>

                        @{
                            RenderCategoryRow(item.Id, places);
                        }
                    </ul>
                </li>
                }
            }
        }
}
<div class="modal fade" id="placeModal" tabindex="-1" role="dialog" aria-labelledby="placeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
        <div class="modal-content">

            <!-- Header مدال -->
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="placeModalLabel" style="color:#fff!important;">
                    <i class="fas fa-building"></i> انتخاب محل خدمت
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="بستن">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <!-- Body مدال -->
            <div class="modal-body">
                <div id="divCategotyTreeView">
                    <ul style="list-style-type:none;" id="RootTreeView" required>
                        <li>
                            @{
                                RenderCategoryRow(null, workPlaceViewModels);
                            }
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Footer مدال -->
            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary"
                        data-dismiss="modal">
                    انصراف
                </button>
                <button type="button" class="btn btn-primary mr-2" data-btn="save">ثبت انتخاب  </button>
            </div>
        </div>
    </div>
</div>
@section Scripts{
    <style>
        .input-group .input-group-append {
            right: 10px;
        }
    </style>


    <script>
        $(document).ready(function () {
            $("#divCategotyTreeView input[type=checkbox]").change(function () {


                if ($('#divCategotyTreeView input:checkbox:checked').length > 1) {
                    var tthis = $(this);
                    $(this).prop('checked', false);
                    Swal.fire({
                        icon: 'info',
                        title: `<span">گزینه دیگری در حال انتخاب است و شما فقط می توانید یک مورد را انتخاب نمائید</span>`,
                        showConfirmButton: false,
                        timer: 3000
                    })
                }

            });
            // hide childe treeView
            $(function () {
                $('#RootTreeView ul.child2').hide(300);

                $('#RootTreeView li').on('click', function (e) {

                    e.stopPropagation();
                    $(this).children('ul').toggle(500);
                    $(this).children('li').addClass('mr-4');
                    $(this).children('ul').addClass('mr-4');
                    // $(this).find('>:first-child').toggleClass('fa-plus-circle fa-minus-circle')
                    $(this).find('>:first-child').toggleClass('fa-folder  fa-folder-open')

                });
            });

               $('[data-btn="save"]').click(function (e) {
                e.preventDefault();
                $('input[type=checkbox]').each(function () {
                    if (this.checked) {
                    $('#placeModal').modal('hide');
                    var url = '/Person/HourlyLeave/AttendanceSummary?worckpalce=' + $(this).val();
                   window.location.href = url;
                   
                    }
                });

            });
        });
    </script>
}

