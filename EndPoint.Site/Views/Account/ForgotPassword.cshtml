@model Azmoon.Application.Service.User.Dto.ForgotPasswordDto
@{
    ViewData["Title"] = "بازیابی رمز عبور";
    Layout = "~/Views/Account/_Layout2.cshtml";
}


@*<partial name="_BublesAndCirclesPrtial" />*@
<div class="col-sm-12 col-md-4 col-lg-4 offset-md-4 mt-md-5 mt-lg-5 card" style="z-index: 100; position: absolute; background: rgba(27,80,83, .4);color:aliceblue ">
    <h3 class="mt-2" style="color:aliceblue;">بازیابی رمز عبور</h3>


    <form asp-action="ForgotPassword" id="ForgotPasswordForm">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>


        <div class="form-group">
         @*   <label asp-for="personeli" class="control-label"></label>*@
            <input asp-for="personeli" type="number" class="form-control" pattern="(^40)?(\d{9}$)" required  placeholder="شماره پرسنلی"/>
            <span asp-validation-for="personeli" class="text-danger"></span>
        </div>
        <div class="form-group">
          @*  <label asp-for="melli" class="control-label"></label>*@
            <input asp-for="melli" class="form-control" type="number" pattern="^[0-9]{10}$" required  placeholder=" کد ملی" />
            <span asp-validation-for="melli" class="text-danger"></span>
        </div>
        <div class="form-group">
            
            <input asp-for="Phone" class="form-control" type="number" pattern="(^09)?(\d{11})$" placeholder="موبایل مثال : 09123654789" required />
            <span asp-validation-for="Phone" class="text-danger"></span>
        </div>
        <div class="form-group">
       @*     <label asp-for="name_father" class="control-label"></label>*@
            <input asp-for="name_father" class="form-control" pattern="^(?:[a-zA-Z\s,=%$#&_\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDCF\uFDF0-\uFDFF\uFE70-\uFEFF]|(?:\uD802[\uDE60-\uDE9F]|\uD83B[\uDE00-\uDEFF])){3,15}$" required  placeholder="نام پدر "/>
            <span asp-validation-for="name_father" class="text-danger"></span>
        </div>
        <div class="">
        

            <div class="row mt-2">
              
           
            <img alt="عبارت_امنیتی" id="imgcpatcha" src="@Url.Action("CaptchaImage","Captcha")" class="col-sm-12 col-md-12" style="height:37px" />

            </div>
               <div class="form-group">
            <label for="CaptchaInputText" class="control-label"></label>
            <input name="CaptchaInputText" id="CaptchaInputText" class="form-control" type="number" pattern="(\d{2})$" placeholder="حاصل جمع عدد بالا را وارد کنید" required />
            <span asp-validation="CaptchaInputText" class="text-danger"></span>
        </div>
        </div>
        <div class="col-12 center text-center mt-2 mb-2">
            <input type="submit" value="ثبت" data-btn="save" class="btn btn-primary col-6" />
        </div>
    </form>


</div>
<div id="canvas_container"></div>

<div class="modal fade" id="exampleModal" role="dialog" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div id="formChangePassword">

            </div>
        </div>
    </div>
</div>
<div id="overlay">
    <div class="cv-spinner">
        <span class="spinner"></span>
    </div>
</div>
@section StyleSheet
{
    <link href="~/backend/css/Spiner.css" rel="stylesheet" />
    <link href="~/assets/css/jOmaBQK.css" rel="stylesheet" />
    <link href="~/lib/MD_BootstrapPersianDateTimePicker-master-bs5/dist/jquery.md.bootstrap.datetimepicker.style.css" rel="stylesheet" />
    <link href="~/lib/SweetAlert/sweetalert2.css" rel="stylesheet" />

}
@section Scripts{

   <script src="~/assets/js/three.min.js"></script>
    <script src="~/assets/js/OrbitControls.js"></script>
    <script src="~/assets/js/simplex-noise.min.js"></script>
    <script src="~/assets/js/jOmaBQK.js"></script>
    <partial name="_ValidationScriptsPartial" />
    <script src="~/lib/SweetAlert/sweetalert2.js"></script>
    <script src="~/lib/SweetAlert/polyfill.js.js"></script>
    <script src="~/lib/MD_BootstrapPersianDateTimePicker-master-bs5/dist/jquery.md.bootstrap.datetimepicker.js"></script>
    <script src="~/Them/js/timezone.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {

    
 
            $('#date5').MdPersianDateTimePicker({
                targetTextSelector: '#StartDateFake',
                targetDateSelector: '#tavalod',
                groupId: 'date5',
                //fromDate: true,
                //enableTimePicker: true,
                format: "YYYY/MM/DD",
                modalMode: true,
                yearOffset: 60,
            });
            $('#StartDateFake').MdPersianDateTimePicker({
                targetTextSelector: '#StartDateFake',
                targetDateSelector: '#tavalod',
                groupId: 'date5',
                //fromDate: true,
                //enableTimePicker: true,
                format: "YYYY/MM/DD",
                modalMode: true,
                yearOffset: 60,
            });

        });
        $('[data-btn="save"]').click(function (e) {
            e.preventDefault();
            if ($('form#ForgotPasswordForm').valid()) {
                 $("#overlay").fadeIn(300);
                $.ajax({
                    url: '/Account/ForgotPassword',
                    type: 'post',
                    dataType: 'json',
                    data: $('form#ForgotPasswordForm').serialize(),
                    success: function (result) {
                         $("#overlay").fadeOut(300);
                        if (result.isSuccess) {
                       
                            $('#formChangePassword').empty();
                            $('#formChangePassword').html(result.data);
                            Swal.fire({
                                icon: 'success',
                                title: "",
                                showConfirmButton: false,
                                timer: 1000
                            })

                        }
                        else {
                    
                            Swal.fire({
                                icon: 'warning',
                                title: result.message,
                                showConfirmButton: false,
                                timer: 5000
                            })
                                     setInterval(function() {
                                    window.location.href = '/Account/ForgotPassword';
                                }, 5000);

                        }
                    },
                    error: function (data) {
                        Swal.fire({
                            icon: 'error',
                            title: 'اطلاعات و مقادیر وارد شده نادرست می باشد دقت فرمائید!!',
                            showConfirmButton: false,
                            timer: 3000
                        })
                    }

                });
            }
            else {
                Swal.fire({
                    icon: 'error',
                    title: 'در ورود اطلاعات و مقادیر دقت فرمائید!!',
                    showConfirmButton: false,
                    timer: 3000
                })
            }


        });



    </script>
    <script>

        $(document).ready(function (e) {
            $('#exampleModal').modal('hide');


            $(document).on('click', '[data-btn="changepassword"]', function (e) {
                console.log("click  :", "changepassword");
                e.preventDefault();
                var inputs = $(document).find('input[type="password"]');



                var resultOk = false;
                if ($(inputs[0]).val() !== undefined && $(inputs[0]).val() !== null && $(inputs[0]).val() !== "") {
                    if ($(inputs[1]).val() !== undefined && $(inputs[1]).val() !== null && $(inputs[1]).val() !== "") {
                        if ($(inputs[0]).val() == $(inputs[1]).val()) {
                            resultOk = true;
                        }
                    }
                }
                if (resultOk) {

                    var passworddd = $(inputs[0]).val();

                    var rePassworddd = $(inputs[1]).val();
                    var userId = document.getElementById('UserId').value;
                     $("#overlay").fadeIn(300);
                    $.ajax({
                        url: "/Account/ResetPassword",
                        data: { Password: passworddd, RePassword: rePassworddd, userId: userId },
                        type: "Post",
                        dataType: "Json",
                        success: function (result) {
                             $("#overlay").fadeOut(300);
                            if (result.isSuccess) {
                                $('#exampleModal').modal('hide');

                                Swal.fire({
                                    icon: 'info',
                                    title: result.message,
                                    showConfirmButton: false,
                                    timer: 2000
                                });
                                setTimeout(() => { window.location.href = result.data }, 2000);

                            }
                            else {
                                $('#exampleModal').modal('hide');

                                Swal.fire({
                                    icon: 'info',
                                    title: result.message,
                                    showConfirmButton: false,
                                    timer: 3000
                                })
                                      setInterval(function() {
                                    window.location.href = '/Account/ForgotPassword';
                                }, 3000);
                            }

                        },
                        error: function () {
                            $(inputs[0]).empty();
                            $(inputs[0]).attr('placeholder', 'مقادیر رمز را به درستی وارد نمائید');
                            $(inputs[0]).css({ "border-color": "red" });


                            $(inputs[1]).empty();
                            $(inputs[1]).attr('placeholder', 'مقادیر تکرار رمز را به درستی وارد نمائید');
                            $(inputs[1]).css({ "border-color": "red" });


                        }
                    });
                }
                else {
                    $(inputs[0]).attr('placeholder', 'مقادیر رمز را به درستی وارد نمائید');
                    $(inputs[0]).css({ "border-color": "red" });

                    $(inputs[1]).attr('placeholder', 'مقادیر تکرار رمز را به درستی وارد نمائید');
                    $(inputs[1]).css({ "border-color": "red" });
                }
            });
        });
    </script>
}



